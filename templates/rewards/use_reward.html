{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ company_name|default:"R√©compense" }}</title>
  <style>
    :root{
      --g1:#ff4d6d; --g2:#7b2cbf;
      --ink:#1e164b; --muted:#6b6b8a; --surface:#ffffff;
      --shadow: 0 10px 30px rgba(24,17,62,.15);
      --radius: 22px;
      --brand: var(--c1, #6c5ce7);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#f7f8fb;color:#1a1537;font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .hero{
      background:
        radial-gradient(1200px 400px at 10% -10%, rgba(255,255,255,.2), transparent),
        linear-gradient(135deg,var(--g1),var(--g2));
      color:#fff; text-align:center; padding:56px 16px 72px;
    }
    .hero h1{margin:0 0 8px; font-weight:900; letter-spacing:.3px; font-size: clamp(26px, 4.2vw, 48px);}
    .hero p{margin:0; opacity:.95; font-size: clamp(14px, 2.2vw, 20px);}

    .card{
      width:min(760px, calc(100% - 24px));
      margin:-40px auto 40px; background:var(--surface); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
    }

    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:.75rem; padding:18px 22px;
      background: linear-gradient(135deg, rgba(255,255,255,.6), rgba(255,255,255,.35));
      backdrop-filter: blur(6px);
    }
    .badge{
      display:inline-flex; align-items:center; gap:.5rem;
      border-radius:999px; padding:.5rem .9rem;
      font-weight:700; line-height:1; white-space:nowrap;
      box-shadow:0 6px 14px rgba(12,16,32,.12);
      border:1px solid transparent;
      max-width:100%;
      font-size:13px;
    }
    .chip-primary{
      background:#0b1020; color:#fff; border-color:#0b1020;
      box-shadow:0 6px 16px rgba(11,16,32,.28), 0 0 0 2px color-mix(in oklab, var(--brand) 25%, #ffffff);
    }
    .chip-emoji{ font-size:1.05em; }
    .chip-text{
      display:inline-block; overflow:hidden; text-overflow:ellipsis;
      max-width: min(78vw, 520px);
      font-size: clamp(12px, 3.4vw, 14px);
    }
    .badge-sec{ background:#eef2f7; color:#111827; font-weight:600; border-color:#e6ebf1; }
    .chip-secure::before{ content:"üîí"; margin-right:.35rem; }

    .card-body{padding:22px;}
    h2{margin:6px 0 14px; font-size:32px; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:14px;}

    .panel{
      border:1px dashed #e5e6ef; padding:16px; border-radius:14px; background:#fbfbfe; color:#2a2942;
    }
    .row{display:flex; gap:14px; flex-wrap:wrap; margin-top:14px}
    .row > *{flex:1 1 220px}

    /* ---- LIEN A COPIER : tient toujours dans la carte ---- */
    .codebox{
      display:flex; align-items:center; gap:10px;
      border:1px solid #ececf6; padding:12px 14px; border-radius:12px; background:#fff;
      width:100%; overflow:hidden;
    }
    .codebox .url{
      display:block;            /* important pour ellipsis */
      flex:1 1 auto;
      min-width:0;              /* autorise la r√©duction dans le flex */
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      direction:ltr;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .codebox .btn{ flex:0 0 auto; }

    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer;
      background:#0f1226; color:#fff; box-shadow:0 6px 16px rgba(15,18,38,.18);
    }
    .btn.secondary{background:#eef0f6; color:#1e1a3a; box-shadow:none;}
    .footer{ text-align:center; color:#8b8aa7; font-size:14px; padding-bottom:32px;}

    @media (max-width: 480px){
      .card-head{ flex-wrap:wrap; }
      .chip-primary{ flex:1 1 100%; justify-content:center; padding:.65rem 1rem; }
      .badge-sec{ margin-left:auto; padding:.5rem .75rem; }
      .btn{ padding:12px 14px; }
    }
    @media (max-width: 360px){
      .chip-text{ max-width: 72vw; }
      .badge-sec{ font-size:.92rem; }
      .btn{ padding:10px 12px; font-size:13px; }
    }

    @media (prefers-color-scheme: dark){
      body{background:#0e0f17; color:#e9e8f3}
      .card{background:#131527}
      .card-head{background:rgba(255,255,255,.05)}
      .panel{background:#0f1020; border-color:#262842}
      .codebox{background:#0f1020; border-color:#262842}
      .btn.secondary{background:#1b1d37; color:#fff}
      .footer{color:#a7a6c2}
      .badge-sec{ background:#1b2130; color:#e8ecf6; border-color:#263146; }
    }
  </style>
</head>
<body>

  <section class="hero">
    <div style="font-size:28px; line-height:1">üéâ</div>
    <h1>{{ headline }}</h1>
    {% if celebrate %}<p>{{ celebrate }}</p>{% endif %}
    {% if subline %}<p style="margin-top:8px; opacity:.85">{{ subline }}</p>{% endif %}
  </section>

  <main class="card" role="main" aria-labelledby="gift-title">
    <div class="card-head" role="group" aria-label="statut du parrainage">
      <div class="badge chip-primary">
        <span class="chip-emoji" aria-hidden="true">üéÅ</span>
        <span class="chip-text">{{ ribbon|default:"Ton cadeau" }}</span>
      </div>
      <div class="badge badge-sec chip-secure">Lien s√©curis√©</div>
    </div>

    <div class="card-body">
      <div class="muted" style="margin-bottom:6px">{{ company_name }}</div>
      <h2 id="gift-title">{{ reward.label }}</h2>

      {% if reward.valid_until %}
        <div class="muted" style="margin:8px 0 16px">
          Date limite d‚Äôutilisation : {{ reward.valid_until|date:"d F Y" }}
        </div>
      {% endif %}

      <div class="panel">
        Pr√©sentez <strong>ce lien</strong> en caisse. Un membre de l‚Äô√©quipe validera la r√©compense.
        <div class="row">
          <div>
            <div class="muted" style="margin:10px 0 6px">Ton lien</div>
            <div class="codebox" id="copybox">
              <!-- Affichage raccourci mais copie = URL compl√®te -->
              <span class="url" id="copyUrl" data-full="{{ claim_absolute }}">{{ claim_absolute }}</span>
              <button class="btn" id="copyBtn" data-url="{{ claim_absolute }}" aria-label="Copier le lien">Copier le lien</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="footer">
    Merci pour la recommandation ‚ù§Ô∏è ‚Äî {{ company_name|default:"" }}
  </div>

  <script>
    (function(){
      // Copie du lien complet
      const btn = document.getElementById('copyBtn');
      if (btn) {
        btn.addEventListener('click', async function(){
          try{
            const url = btn.getAttribute('data-url') || location.href;
            await navigator.clipboard.writeText(url);
            btn.textContent = "Copi√© !";
            setTimeout(()=> btn.textContent = "Copier le lien", 1600);
          }catch(e){
            alert("Lien: " + (btn.getAttribute('data-url') || location.href));
          }
        });
      }

      // Ellipsis AU MILIEU si n√©cessaire (le span tient toujours dans la carte)
      const urlEl = document.getElementById('copyUrl');
      function middleEllipsize(el){
        if(!el) return;
        const full = el.getAttribute('data-full') || el.textContent || "";
        el.textContent = full; // reset

        // si √ßa tient d√©j√†, on sort
        if (el.scrollWidth <= el.clientWidth) return;

        // on garde un peu plus le d√©but (domaine) que la fin
        let left = Math.min(28, Math.ceil(full.length * 0.45));
        let right = Math.min(18, Math.ceil(full.length * 0.3));

        // boucle d'ajustement
        for (let i=0; i<80; i++){
          el.textContent = full.slice(0,left) + "‚Ä¶" + full.slice(-right);
          if (el.scrollWidth <= el.clientWidth) return;
          if (left > right) { left--; } else { right--; }
          if (left < 6 && right < 6) break;
        }
        // fallback mini
        el.textContent = full.slice(0, Math.max(6,left)) + "‚Ä¶" + full.slice(-Math.max(6,right));
      }
      function fit(){ middleEllipsize(urlEl); }
      window.addEventListener('load', fit);
      window.addEventListener('resize', fit);
      // sur certains navigateurs mobiles, le layout final n'arrive qu'apr√®s "pageshow"
      window.addEventListener('pageshow', fit);
    })();
  </script>
</body>
</html>

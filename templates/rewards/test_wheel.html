{% extends "base_dashboard.html" %}
{% block title %}Roue de test • Chuchote{% endblock %}
{% block body_data_page %}recompenses{% endblock %}

{% block content %}
<style>
.wheel { --accent:#6c757d; width:300px; height:300px; border-radius:50%;
  border:8px solid var(--accent); position:relative; margin:0 auto;
  box-shadow:0 0 0 4px rgba(0,0,0,.03), 0 0 30px rgba(0,0,0,.06) inset;
  transition: box-shadow .3s ease, border-color .3s ease;
}
.wheel.is-spinning { box-shadow:0 0 0 4px rgba(0,0,0,.03), 0 0 46px var(--accent); }
.wheel::after{ content:""; position:absolute; top:-20px; left:50%; transform:translateX(-50%);
  width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent;
  border-bottom:22px solid var(--accent); filter: drop-shadow(0 2px 0 rgba(0,0,0,.15));
}
.wheel__disk{ position:absolute; inset:16px; border-radius:50%;
  background: conic-gradient(
    rgba(25,135,84,.90) 0deg,   rgba(25,135,84,.90) 90deg,
    rgba(13,202,240,.90) 90deg, rgba(13,202,240,.90) 180deg,
    rgba(253,126,20,.92) 180deg,rgba(253,126,20,.92) 270deg,
    rgba(220,53,69,.92) 270deg, rgba(220,53,69,.92) 360deg
  );
  transform-origin:50% 50%;
}
.spin-anim { transition: transform 2.2s cubic-bezier(.17,.67,.13,1.02); }
.wheel--success { --accent:#198754; }  /* SOUVENT */
.wheel--info    { --accent:#0dcaf0; }  /* MOYEN   */
.wheel--warning { --accent:#fd7e14; }  /* RARE    */
.wheel--danger  { --accent:#dc3545; }  /* TRES_RARE */
.wheel--secondary { --accent:#6c757d; } /* NO_HIT  */
.result-card { border-left:4px solid var(--accent); }
</style>

<header class="mb-4 d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h5 mb-1">Roue de test (aléatoire, sans attribution)</h1>
    <div class="text-secondary">Tire au sort un bucket selon la distribution choisie.</div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'rewards:list' %}">← Récompenses</a>
</header>

<form class="card mb-3" method="get">
  <div class="card-body row g-2 align-items-end">
    <div class="col-sm-4">
      <label class="form-label">Mode</label>
      <select name="mode" class="form-select">
        <option value="combined" {% if mode == 'combined' %}selected{% endif %}>Combiné (1/100000 très rare + base 980/19/1)</option>
        <option value="base" {% if mode == 'base' %}selected{% endif %}>Base (SOUVENT/MOYEN/RARE)</option>
        <option value="very_rare" {% if mode == 'very_rare' %}selected{% endif %}>Très rare uniquement</option>
      </select>
    </div>
    <div class="col-sm-3">
      <label class="form-label">Seed (optionnel)</label>
      <input type="text" class="form-control" name="seed" value="{{ seed }}">
    </div>
    <div class="col-sm-3">
      <label class="form-label">Simuler N tirages (optionnel)</label>
      <input type="number" class="form-control" name="n" value="{{ simulate_n|default:0 }}" min="0" step="1">
    </div>
    <div class="col-sm-2 d-flex gap-2">
      <button class="btn btn-primary w-100" type="submit">Tirer</button>
      <a class="btn btn-outline-secondary" href="{% url 'rewards:test_wheel' %}">Reset</a>
    </div>
  </div>
</form>

<div class="card shadow-sm mb-3">
  <div class="card-body d-flex flex-column align-items-center">
    <div class="wheel wheel--{{ ui.badge }} is-spinning">
      <div id="disk" class="wheel__disk spin-anim"></div>
    </div>
    <div class="mt-4 text-center result-card px-3 py-2 rounded">
      <span class="badge text-bg-{{ ui.badge }} me-2">
        {% if bucket == 'NO_HIT' %}Aucun gain{% else %}{{ ui.label }}{% endif %}
      </span>
      <strong id="rewardLabel">
        {% if bucket == 'SOUVENT' %}-10 %{% elif bucket == 'MOYEN' %}-20 %{% elif bucket == 'RARE' %}Cadeau rare{% elif bucket == 'TRES_RARE' %}Jackpot !{% else %}—{% endif %}
      </strong>
    </div>
  </div>
</div>

{% if counts %}
<div class="card">
  <div class="card-header">Simulation ({{ simulate_n }} tirages)</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr><th>Bucket</th><th>Occurences</th><th>% observé</th></tr>
        </thead>
        <tbody>
          {% for k,v in counts.items %}
          <tr>
            <td>{{ k }}</td>
            <td>{{ v }}</td>
            <td>{{ pct|get_item:k|default:"0" }} %</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="text-secondary small">
      Combiné attendu (théorique) : TRES_RARE ≈ 0.001 %, sinon base 980/1000, 19/1000, 1/1000.
    </div>
  </div>
</div>
{% endif %}

<script>
(function(){
  const disk = document.getElementById('disk');
  const target = {{ target_angle|default:1440 }};
  setTimeout(()=>{ disk.style.transform = `rotate(${target}deg)`; }, 60);
  disk.addEventListener('transitionend', () => {
    const wheel = disk.closest('.wheel');
    wheel && wheel.classList.remove('is-spinning');
  }, { once: true });
})();
</script>
{% endblock %}

{% extends "base_dashboard.html" %}
{% block title %}Roulette de récompense • ParrainApp{% endblock %}
{% block body_data_page %}recompenses{% endblock %}

{% block content %}
<style>
/* --------- Variables de teinte ---------- */
.wheel {
  --accent: #6c757d; /* fallback */
  width: 300px; height: 300px;
  border-radius: 50%;
  border: 8px solid var(--accent);
  position: relative;
  margin: 0 auto;
  box-shadow:
    0 0 0 4px rgba(0,0,0,.03),
    0 0 30px rgba(0,0,0,.06) inset;
  transition: box-shadow .3s ease, border-color .3s ease;
}
.wheel.is-spinning { box-shadow: 0 0 0 4px rgba(0,0,0,.03), 0 0 46px var(--accent); }

/* Aiguille (triangle en haut) */
.wheel::after{
  content:"";
  position:absolute; top:-20px; left:50%; transform:translateX(-50%);
  width:0; height:0;
  border-left: 12px solid transparent;
  border-right:12px solid transparent;
  border-bottom:22px solid var(--accent);
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.15));
}

/* Disque interne : conic-gradient 4 segments dans l’ordre SOUVENT/MOYEN/RARE/TRES_RARE */
.wheel__disk{
  position:absolute; inset: 16px;
  border-radius:50%;
  background:
    conic-gradient(
      rgba(25,135,84,.90) 0deg,   rgba(25,135,84,.90) 90deg,   /* success  -> SOUVENT */
      rgba(13,202,240,.90) 90deg, rgba(13,202,240,.90) 180deg, /* info     -> MOYEN   */
      rgba(253,126,20,.92) 180deg,rgba(253,126,20,.92) 270deg, /* orange   -> RARE    */
      rgba(220,53,69,.92) 270deg, rgba(220,53,69,.92) 360deg   /* danger   -> TRES_RARE */
    );
  transform-origin:50% 50%;
}

/* Animation de rotation */
.spin-anim { transition: transform 2.2s cubic-bezier(.17,.67,.13,1.02); }

/* Map badge -> couleur d’accent */
.wheel--success { --accent:#198754; } /* vert   */
.wheel--info    { --accent:#0dcaf0; } /* bleu   */
.wheel--warning { --accent:#fd7e14; } /* orange */
.wheel--danger  { --accent:#dc3545; } /* rouge  */

/* Carte résultat */
.result-card { border-left: 4px solid var(--accent); }
</style>

<header class="mb-4 d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h5 mb-1">Animation de la roue</h1>
    <div class="text-secondary">
      Récompense attribuée à <strong>{{ reward.client.last_name }} {{ reward.client.first_name }}</strong>
    </div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'dashboard:client_detail' pk=reward.client_id %}">Retour fiche client</a>
</header>

<div class="card shadow-sm">
  <div class="card-body d-flex flex-column align-items-center">
    {# La classe wheel--{{ ui.badge }} pose la bonne couleur (success/info/warning/danger) #}
    <div class="wheel wheel--{{ ui.badge }} is-spinning">
      <div id="disk" class="wheel__disk spin-anim"></div>
    </div>

    <div class="mt-4 text-center result-card px-3 py-2 rounded">
      <span class="badge text-bg-{{ ui.badge }} me-2">{{ ui.label }}</span>
      <strong id="rewardLabel">{{ reward.label }}</strong>
    </div>
  </div>
</div>

<script>
(function(){
  const disk = document.getElementById('disk');
  const target = {{ target_angle|default:1440 }};
  // Lance la rotation après un mini délai pour laisser le layout se peindre
  setTimeout(()=>{ disk.style.transform = `rotate(${target}deg)`; }, 60);
  // Retire l'état “is-spinning” une fois l’animation finie (effet de lueur)
  disk.addEventListener('transitionend', () => {
    const wheel = disk.closest('.wheel');
    wheel && wheel.classList.remove('is-spinning');
  }, { once: true });
})();
</script>
{% endblock %}

<header class="mb-4">
  <h1 class="h4 section-title mb-1">Fiche client</h1>
  <div class="text-secondary">Informations, cadeaux et historique</div>
</header>

<div class="row g-3">
  <!-- Colonne infos -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100"><div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <h3 class="h6 mb-0">Informations</h3>
        {% if client.is_referrer %}
          <span class="badge text-bg-info">Parrain</span>
        {% endif %}
      </div>

      <div class="vstack gap-1 small">
        <div><span class="text-secondary">Nom :</span> {{ client.last_name|default:"—" }}</div>
        <div><span class="text-secondary">Prénom :</span> {{ client.first_name|default:"—" }}</div>
        <div><span class="text-secondary">Téléphone :</span> {{ client.phone|default:"—" }}</div>
        <div><span class="text-secondary">Email :</span> {{ client.email|default:"—" }}</div>
      </div>

      <hr>

      <div class="d-flex justify-content-between align-items-center">
        <div class="small">
          <span class="text-secondary">A parrainé :</span>
          <strong>{{ referrals|length }}</strong>
        </div>
        {% if referrals %}
          <a class="btn btn-sm btn-outline-primary" href="{% url 'dashboard:clients_list' %}?company={{ company.id }}">
            Voir la liste
          </a>
        {% endif %}
      </div>
    </div></div>
  </div>

  <!-- Colonne droite -->
  <div class="col-lg-8">
    <div class="row g-3">

     {# --- BLOCS CADEAUX (3 colonnes) --- #}
<div class="col-12">
  <div class="row g-3">

    {# Cadeau obtenu #}
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Cadeau obtenu</div>
          <span class="badge text-bg-success">{{ gifts_obtained|length }}</span>
        </div>
        <div class="card-body">
          {% if gifts_obtained %}
            <div class="vstack gap-3">
              {% for g in gifts_obtained %}
                <div class="border rounded p-2">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="fw-semibold">{{ g.title }}</div>
                      <small class="text-secondary">Créé le {{ g.created_at }}</small>
                    </div>
                    <span class="badge text-bg-success">OK</span>
                  </div>
                  <hr class="my-2">
                  <div class="vstack small gap-1">
                    <div><span class="text-secondary">Canal :</span> {{ g.channel|default:"—" }}</div>
                    <div><span class="text-secondary">Code :</span> {{ g.code|default:"—" }}</div>
                  </div>
                  {% if g.actions %}
                    <div class="d-flex gap-2 mt-2">
                      {% for btn in g.actions %}
                        <a class="btn btn-sm btn-outline-primary" href="{{ btn.href }}">{{ btn.label }}</a>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-secondary small">Aucun cadeau obtenu.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# Cadeau non-atteint (ou “non-entrant” selon ton wording) #}
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Cadeau non-atteint</div>
          <span class="badge text-bg-warning">{{ gifts_not_achieved|length }}</span>
        </div>
        <div class="card-body">
          {% if gifts_not_achieved %}
            <div class="vstack gap-3">
              {% for g in gifts_not_achieved %}
                <div class="border rounded p-2">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="fw-semibold">{{ g.title }}</div>
                      <small class="text-secondary">Créé le {{ g.created_at }}</small>
                    </div>
                    <span class="badge text-bg-warning">En attente</span>
                  </div>
                  <hr class="my-2">
                  <div class="vstack small gap-1">
                    <div><span class="text-secondary">Progression :</span> {{ g.progress|default:"—" }}</div>
                    <div><span class="text-secondary">Objectif :</span> {{ g.goal|default:"—" }}</div>
                  </div>
                  {% if g.actions %}
                    <div class="d-flex gap-2 mt-2">
                      {% for btn in g.actions %}
                        <a class="btn btn-sm btn-outline-primary" href="{{ btn.href }}">{{ btn.label }}</a>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-secondary small">Aucun cadeau en attente d’atteinte.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# Cadeau non-utilisé #}
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Cadeau non-utilisé</div>
          <span class="badge text-bg-secondary">{{ gifts_not_used|length }}</span>
        </div>
        <div class="card-body">
          {% if gifts_not_used %}
            <div class="vstack gap-3">
              {% for g in gifts_not_used %}
                <div class="border rounded p-2">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="fw-semibold">{{ g.title }}</div>
                      <small class="text-secondary">Créé le {{ g.created_at }}</small>
                    </div>
                    <span class="badge text-bg-secondary">Non-utilisé</span>
                  </div>
                  <hr class="my-2">
                  <div class="vstack small gap-1">
                    <div><span class="text-secondary">Code :</span> {{ g.code|default:"—" }}</div>
                    <div><span class="text-secondary">Expire le :</span> {{ g.expires_at|default:"—" }}</div>
                  </div>
                  {% if g.actions %}
                    <div class="d-flex gap-2 mt-2">
                      {% for btn in g.actions %}
                        <a class="btn btn-sm btn-outline-primary" href="{{ btn.href }}">{{ btn.label }}</a>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-secondary small">Aucun cadeau en attente d’utilisation.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

{# --- Historique des parrainages (inchangé) --- #}
<div class="col-12 mt-3">
  <div class="card shadow-sm">
    <div class="card-header">Historique des parrainages</div>
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="table-light">
          <tr><th>Parrainé</th><th>Date</th><th>Récompense</th></tr>
        </thead>
        <tbody>
          {% for h in referral_history %}
            <tr>
              <td>{{ h.referee_name }}</td>
              <td>{{ h.date }}</td>
              <td>{{ h.reward_title }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="text-secondary small">Aucun historique.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

      <!-- Historique des parrainages -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header">Historique des parrainages</div>
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Parrainé</th>
                  <th>Date</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                {% for ref in referrals %}
                  <tr>
                    <td>{{ ref.referee.last_name }} {{ ref.referee.first_name }}</td>
                    <td>{{ ref.created_at|date:"d/m/Y" }}</td>
                    <td>{{ ref.get_status_display }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="3" class="text-center text-secondary">Aucun parrainé pour ce client.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div><!-- row -->
  </div><!-- col -->
</div><!-- row -->

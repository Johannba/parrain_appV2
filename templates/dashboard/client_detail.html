{# templates/dashboard/client_detail.html #}
{% extends "base_dashboard.html" %}
{% block title %}Fiche client — {{ client.last_name }} {{ client.first_name }}{% endblock %}
{% block body_data_page %}clients{% endblock %}
{% block nav_clients_active %}active{% endblock %}
{% load url_extras %}

{% block content %}
<style>
  .tall-card .card-body { max-height: 360px; overflow: auto; }
  @media (min-width: 1400px){
    .tall-card .card-body { max-height: 420px; }
  }
</style>

<header class="mb-3">
  <h1 class="h4 section-title mb-1">Fiche client</h1>
  <div class="text-secondary">Informations, cadeaux et historique</div>
</header>

<div class="row g-3">

  {# --------- COLONNE GAUCHE --------- #}
  <div class="col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <h2 class="h6 mb-3">Informations</h2>
          {% if client.is_referrer %}
            <span class="badge text-bg-info">Parrain</span>
          {% else %}
            <span class="badge text-bg-secondary">Filleul</span>
          {% endif %}
        </div>

        <div class="vstack gap-1 small mb-3">
          <div><span class="text-secondary">Nom :</span> {{ client.last_name|default:"—" }}</div>
          <div><span class="text-secondary">Prénom :</span> {{ client.first_name|default:"—" }}</div>
          <div><span class="text-secondary">Téléphone :</span> {{ client.phone|default:"—" }}</div>
          <div><span class="text-secondary">Email :</span> {{ client.email|default:"—" }}</div>
          <div><span class="text-secondary">Entreprise :</span> {{ company.name }}</div>
        </div>

        <a href="{% url 'rewards:history_company' %}"
           class="btn btn-sm btn-outline-primary">Historique des récompenses (entreprise)</a>

        <hr class="my-2">

        <div class="fw-semibold mb-2">Historique des parrainages</div>

        <div class="tall-card">
          <div class="card-body p-0">
            {% if history_page and history_page.object_list %}
              <div class="list-group list-group-flush">
                {% for r in history_page.object_list %}
                  <div class="list-group-item d-flex justify-content-between">
                    <div class="me-2">
                      {% if r.referrer_id == client.id %}
                        <strong>{{ r.referee.first_name }} {{ r.referee.last_name }}</strong>
                        <small class="text-secondary d-block">Parrainé par {{ client.first_name }} {{ client.last_name }}</small>
                      {% else %}
                        <strong>{{ r.referrer.first_name }} {{ r.referrer.last_name }}</strong>
                        <small class="text-secondary d-block">Parrain de ce client</small>
                      {% endif %}
                      <small class="text-secondary">{{ r.created_at|date:"d/m/Y" }}</small>
                    </div>

                    <div class="d-flex flex-column gap-1 align-items-end">
                      {% if r.referrer_id == client.id %}
                        {% if r.existing_reward_id %}
                          <a class="btn btn-sm btn-outline-secondary"
                             href="{% url 'rewards:spin' reward_id=r.existing_reward_id %}">
                            Distribués
                          </a>
                        {% else %}
                          <form method="post" action="{% url 'dashboard:validate_referral_and_award_referrer' referral_id=r.id %}">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-primary">Attribuer</button>
                          </form>
                        {% endif %}
                      {% endif %}

                      <form method="post"
                            action="{% url 'rewards:referral_delete' r.id %}"
                            onsubmit="return confirm('Supprimer ce parrainage ?');">
                        {% csrf_token %}
                        <input type="hidden" name="back_client" value="{{ client.id }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>

              {% if history_page.paginator.num_pages > 1 %}
                <div class="card-footer bg-transparent d-flex justify-content-end gap-2">
                  {% if history_page.has_previous %}
                    <a class="btn btn-sm btn-outline-secondary"
                       href="?h={{ history_page.previous_page_number }}&ok={{ page_ok.number }}&pending={{ page_pending.number }}&unused={{ page_unused.number }}">
                      Préc.
                    </a>
                  {% endif %}
                  <span class="small align-self-center">
                    Page {{ history_page.number }}/{{ history_page.paginator.num_pages }}
                  </span>
                  {% if history_page.has_next %}
                    <a class="btn btn-sm btn-outline-secondary"
                       href="?h={{ history_page.next_page_number }}&ok={{ page_ok.number }}&pending={{ page_pending.number }}&unused={{ page_unused.number }}">
                      Suiv.
                    </a>
                  {% endif %}
                </div>
              {% endif %}

            {% else %}
              <div class="p-3 text-secondary">Aucun parrainage.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# --------- COLONNE DROITE --------- #}
  <div class="col-lg-8">

    {# 1) Cadeaux distribués (SENT) #}
    <div class="card shadow-sm tall-card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Cadeaux distribués <span class="badge rounded-pill text-bg-success">{{ kpi_obtenus }}</span></span>
      </div>
      <div class="card-body">
        {% if page_ok and page_ok.object_list %}
          <div class="list-group list-group-flush">
            {% for rw in page_ok.object_list %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ rw.label }}</div>
                  <small class="text-secondary">Obtenu le {{ rw.created_at|date:"d/m/Y" }}</small>
                </div>
                <span class="badge text-bg-success">OK</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-secondary">Aucun cadeau obtenu.</div>
        {% endif %}
      </div>
      {% if page_ok and page_ok.paginator.num_pages > 1 %}
        <div class="card-footer bg-transparent d-flex justify-content-end gap-2">
          {% if page_ok.has_previous %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?ok={{ page_ok.previous_page_number }}&pending={{ page_pending.number }}&unused={{ page_unused.number }}&h={{ history_page.number }}">
              Préc.
            </a>
          {% endif %}
          <span class="small align-self-center">Page {{ page_ok.number }}/{{ page_ok.paginator.num_pages }}</span>
          {% if page_ok.has_next %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?ok={{ page_ok.next_page_number }}&pending={{ page_pending.number }}&unused={{ page_unused.number }}&h={{ history_page.number }}">
              Suiv.
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {# 2) Cadeaux en attente (PENDING) #}
    <div class="card shadow-sm tall-card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Cadeaux en attente <span class="badge rounded-pill text-bg-warning">{{ kpi_attente }}</span>
      </div>

      <div class="card-body">
        {% if page_pending and page_pending.object_list %}
          <div class="list-group list-group-flush">
            {% for rw in page_pending.object_list %}
              {% abs_uri rw.claim_path as claim_abs %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="me-3">
                  <div class="fw-semibold">{{ rw.label }}</div>
                  <small class="text-secondary">Créée le {{ rw.created_at|date:"d/m/Y" }}</small>

                  {% if claim_abs %}
                    <div class="small mt-1 text-break">
                      Lien : <a href="{{ claim_abs }}">{{ claim_abs }}</a>
                    </div>
                    {# >>> AJOUT : délai d'utilisation juste sous le lien <<< #}
                    <div class="small text-secondary mt-1">
                      {{ rw.validity_sentence }}
                    </div>
                  {% else %}
                    <div class="small mt-1 text-warning">
                      Aucun lien encore généré pour cette récompense.
                    </div>
                  {% endif %}
                </div>

                <div class="d-flex flex-column gap-1">
                  <form method="post" action="{% url 'rewards:distribute' rw.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="back_client" value="{{ client.id }}">
                    <button class="btn btn-sm btn-success" type="submit">Distribuer</button>
                  </form>

                  {% if client.email and claim_abs %}
                    <a class="btn btn-sm btn-outline-secondary"
                       href="mailto:{{ client.email }}?subject={{ 'Votre récompense'|urlencode }}&body={{ claim_abs|urlencode }}">
                      Envoyer par e-mail
                    </a>
                  {% endif %}
                  {% if client.phone and claim_abs %}
                    <a class="btn btn-sm btn-outline-secondary"
                       href="sms:{{ client.phone }}?&body={{ claim_abs|urlencode }}">
                      Envoyer par SMS
                    </a>
                  {% endif %}
                  {% if claim_abs %}
                    <button class="btn btn-sm btn-outline-dark" type="button"
                            onclick="navigator.clipboard.writeText('{{ claim_abs|escapejs }}')">
                      Copier le lien
                    </button>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-secondary">Aucun cadeau en attente.</div>
        {% endif %}
      </div>

      {% if page_pending and page_pending.paginator.num_pages > 1 %}
        <div class="card-footer bg-transparent d-flex justify-content-end gap-2">
          {% if page_pending.has_previous %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?pending={{ page_pending.previous_page_number }}&ok={{ page_ok.number }}&unused={{ page_unused.number }}&h={{ history_page.number }}">
              Préc.
            </a>
          {% endif %}
          <span class="small align-self-center">Page {{ page_pending.number }}/{{ page_pending.paginator.num_pages }}</span>
          {% if page_pending.has_next %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?pending={{ page_pending.next_page_number }}&ok={{ page_ok.number }}&unused={{ page_unused.number }}&h={{ history_page.number }}">
              Suiv.
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {# 3) Cadeaux non utilisés (DISABLED) #}
    <div class="card shadow-sm tall-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Cadeaux non utilisés <span class="badge rounded-pill text-bg-secondary">{{ kpi_nonutils }}</span></span>
        <small class="text-secondary">Distribués mais non consommés</small>
      </div>

      <div class="card-body">
        {% if page_unused and page_unused.object_list %}
          <div class="list-group list-group-flush">
            {% for rw in page_unused.object_list %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ rw.label }}</div>
                  <small class="text-secondary">Distribué le {{ rw.created_at|date:"d/m/Y" }}</small>
                </div>
                <span class="badge text-bg-warning">En cours</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-secondary">Aucun cadeau non utilisé.</div>
        {% endif %}
      </div>

      {% if page_unused and page_unused.paginator.num_pages > 1 %}
        <div class="card-footer bg-transparent d-flex justify-content-end gap-2">
          {% if page_unused.has_previous %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?unused={{ page_unused.previous_page_number }}&ok={{ page_ok.number }}&pending={{ page_pending.number }}&h={{ history_page.number }}">
              Préc.
            </a>
          {% endif %}
          <span class="small align-self-center">Page {{ page_unused.number }}/{{ page_unused.paginator.num_pages }}</span>
          {% if page_unused.has_next %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?unused={{ page_unused.next_page_number }}&ok={{ page_ok.number }}&pending={{ page_pending.number }}&h={{ history_page.number }}">
              Suiv.
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
